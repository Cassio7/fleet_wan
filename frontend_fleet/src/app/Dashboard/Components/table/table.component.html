<p *ngIf="loading" class="loading-p">Caricamento dei dati dei veicoli...</p>
<div class="table-container">
  <table *ngIf="vehicleTableData" #vehicleTable mat-table [dataSource]="vehicleTableData" matSort (matSortChange)="onSortChange($event)">
    <!-- Tipologia column -->
    <ng-container matColumnDef="tipologia">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Tipologia </th>
      <td mat-cell *matCellDef="let vehicle">
        <mat-icon style="cursor: pointer;" matTooltip="Qualche informazione sul veicolo (click per maggiori dettagli)">local_shipping</mat-icon>
        vehice.tipologia </td>
    </ng-container>

    <!-- Targa Column -->
    <ng-container matColumnDef="targa">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Targa </th>
      <td mat-cell *matCellDef="let vehicle">
        <div class="plate-container">
          {{ vehicle.plate }}
        </div>
      </td>
    </ng-container>

    <!-- Comune Column -->
    <ng-container matColumnDef="cantiere">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Cantiere </th>
      <td mat-cell *matCellDef="let vehicle"> {{ checkWorksite(vehicle) }} </td>
    </ng-container>

    <!-- GPS Column -->
    <ng-container matColumnDef="GPS">
      <th mat-header-cell *matHeaderCellDef> GPS </th>
      <td mat-cell *matCellDef="let vehicle">
        <div class="warning-container" *ngIf="checkGpsError(vehicle)" [matTooltip]="checkGpsError(vehicle)">
          <mat-icon class="gpsIcon-warning">location_on</mat-icon>
          Warning
        </div>

        <div class="OK-container" matTooltip="GPS funzionante" *ngIf="!checkGpsError(vehicle)">
          <mat-icon class="gpsIcon-OK">location_on</mat-icon>
          OK
        </div>
      </td>
    </ng-container>

    <!-- Antenna Column -->
    <ng-container matColumnDef="antenna">
      <th mat-header-cell *matHeaderCellDef> Antenna </th>
      <td mat-cell *matCellDef="let vehicle">
        <div class="OK-container" *ngIf="!checkAntennaError(vehicle) && vehicle.isRFIDReader" matTooltip="Antenna funzionante">
          <mat-icon class="gpsIcon-OK">wifi</mat-icon>
          OK
        </div>
        <div class="noRFID-container" matTooltip="Non ha un'antenna RFID" *ngIf="!vehicle.isRFIDReader">
          <mat-icon class="noAntennA-icon">wifi_off</mat-icon>
        </div>
        <div class="error-container" *ngIf="vehicle.isRFIDReader && checkAntennaError(vehicle)" [matTooltip]="checkAntennaError(vehicle) ? checkAntennaError(vehicle) : 'Anomalia antenna RFID'">
          <mat-icon class="errorIcon-error">wifi</mat-icon>
          Error
        </div>
      </td>
    </ng-container>

    <!-- Sessione Column -->
    <ng-container matColumnDef="sessione">
      <th mat-header-cell *matHeaderCellDef mat-sort-header> Sessione </th>
      <td mat-cell *matCellDef="let vehicle">
        <!-- icone -->
        <div class="session-error" *ngIf="checkSessionError(vehicle)" [matTooltip]="checkSessionError(vehicle)">
          <div class="error-container">
            {{calculateSessionErrorDays(vehicle)}}gg
          </div>
          <div class="error-container">
            Error
          </div>
        </div>
        <div class="OK-container" *ngIf="!checkSessionError(vehicle) && vehicle.lastValidSession?.period_to" matTooltip="Sessione corretta">
          OK
        </div>
        <!-- se non c'è errore, data nera -->
        <span *ngIf="!checkSessionError(vehicle) && vehicle.lastValidSession?.period_to; else noError">
          {{ vehicle.lastValidSession?.period_to ? (vehicle.lastValidSession.period_from | date: 'dd/MM/yy hh:mm') : '' }}
        </span>
        <!-- se c'è errore, data rossa -->
        <ng-template #noError>
          <span class="session-date">
            {{ vehicle.lastValidSession?.period_to ? (vehicle.lastValidSession.period_from | date: 'dd/MM/yy hh:mm') : '' }}
          </span>
        </ng-template>

      </td>
    </ng-container>


    <!-- Header and Row Definitions -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns, sticky: true"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>
</div>
